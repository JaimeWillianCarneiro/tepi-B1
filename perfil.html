<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Perfil</title>
	<!-- <link href="{% static 'img/Ativo 22.png' %}" rel="icon"> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js" integrity="sha384-zYPOMqeu1DAVkHiLqWBUTcbYfZ8osu1Nd6Z89ify25QV9guujx43ITvfi12/QExE" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js" integrity="sha384-Y4oOpwW3duJdCWv5ly8SCFYWqFDsfob/3GkgExXKV4idmbt98QcxXYs9UoXAB7BZ" crossorigin="anonymous"></script>
<link rel="stylesheet" type="text/css" media="screen" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
   
    <link rel="stylesheet" href="styleperfil.css" >

	<title>AfroPerfil</title> 
</head>
  <body>

<div class="container">
		<div class="main-body">
			<div class="row">
				<div class="col-lg-4">
					<div class="card">
						<div class="card-body">
							
							<div class="d-flex flex-column align-items-center text-center">
								
<div class="box">
	
		<!-- Adiciona um label para a imagem que irá acionar o input -->
		<label class="avatar" for="input-imagem">
			<img id="imagem-preview" onclick="document.getElementById('input-imagem').click();" src="img/avatar.png" alt="Preview da Imagem"> 
		</label>
		<!-- Adiciona o input oculto -->
		<input type="checkbox" id="btn">
		<input type="file" name="avatar" id="input-imagem" >
	
</div>
								<div class="mt-3">
									<h4 id="nomeDoQuerido"></h4>
								
								</div>
							</div>
						
						</div>
					</div>
				</div>
				<div class="col-lg-8">
					<div class="card">
						<div class="card-body">
							<h2 class="d-flex align-items-center position-absolute top-0 start-50 translate-middle-x m-2">Editar perfil</h1>
							
							<div class="row g-3">
								
								<h4 class="d-flex align-items-center mt-5">Informações pessoais</h1>
									<div class="col-md-12">	
									  <label for="inputEmail4" class="form-label">Nome</label>
									  <input type="text" value="" name="nome" class="form-control" id="nome">
									</div>
									<!-- <div class="col-md-6">
									  <label for="inputPassword4" class="form-label">Sobrenome</label>
									  <input type="text" value="" name="sobrenome" class="form-control" id="sobrenome">
									</div> -->
								
									
								
								
									<h4 class="d-flex align-items-center mt-5">Informações para Login</h1>
									  <div class="col-md-12">
										<label for="inputCity" class="form-label">Email</label>
										<input type="text"name="email" class="form-control" id="email">
									  </div>
								
									  <div class="col-md-6">
										<label for="inputCity" class="form-label">Senha</label>
										<input type="password"  class="form-control" id="senha">
									  </div>
									  <div class="col-md-6">
										<label for="inputCity" class="form-label">Confirmar senha</label>
										<input type="password" class="form-control" id="novaSenha">
									  </div>
									<div class="col-12">
									  <button id ="buttonSubmit" class="btn btn-primary">Salvar alterações</button>
									</div>
							</div>
                                		
								
							
							
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->
   
	<script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
		import { getAuth, onAuthStateChanged, updateProfile, updateEmail, updatePassword, EmailAuthProvider, reauthenticateWithCredential, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-auth.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      import  {getStorage, ref, uploadBytes, getDownloadURL} from "https://www.gstatic.com/firebasejs/10.2.0/firebase-storage.js";;
        // Your web app's Firebase configuration
        const firebaseConfig = {
              apiKey: "AIzaSyBOm2dHRfC0pn_8weQ1zixPHz3cNBpYOKE",
              authDomain: "petshop-supimpa.firebaseapp.com",
              projectId: "petshop-supimpa",
              storageBucket: "petshop-supimpa.appspot.com",
              messagingSenderId: "999502683212",
              appId: "1:999502683212:web:47b6a22f62e6526cf968e9"
            };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
		const storage = getStorage(app);
        const auth = getAuth(app);
    

		console.log("antes");
    
     
	const nomeDoQuerido = document.getElementById("nomeDoQuerido");
	  const input_name = document.getElementById('nome'); 
console.log(nomeDoQuerido)
const input_email = document.getElementById('email');
const  inputPassword = document.getElementById('senha');
const inputNewPassword = document.getElementById('novaSenha');
		// const inputImagem = document.getElementById('input-imagem');
		const imagemPreview = document.getElementById('imagem-preview');
	  const inputImagem = document.getElementById('input-imagem');
		// const novaFoto = inputFile.files[0];
	function getUser(user){


		if (user){
			nomeDoQuerido.textContent = user.displayName;

			input_name.value = user.displayName;
			input_email.value = user.email;
			imagemPreview.src = 
		}
		
		

	}

	// window.onload = function(){
	// 	getUser()
	// }


	


	onAuthStateChanged(auth, function(user){
		getUser(user);
	})







	  //  ALterra imagem do perfil
      imagemPreview.addEventListener('click', function() {
        // Clica no input oculto para acionar o processo de upload
        inputImagem.click();
      });

      inputImagem.addEventListener('change', function() {
        const file = inputImagem.files[0];

        // Cria um objeto FileReader
        const reader = new FileReader();

        // Define a função a ser executada quando a leitura do arquivo for concluída
        reader.onload = function() {
          // Define a prévia da imagem
          imagemPreview.src = reader.result;
        }

        // Lê o arquivo como um URL de dados (data URL)
        reader.readAsDataURL(file);
      });
    
    
        // const buttonSubmit = document.getElementById('submitButton');
    
       
		const buttonSubmit = document.getElementById("buttonSubmit");


		buttonSubmit.addEventListener("click", () => {
            
            const user = auth.currentUser;
            const novoNome = input_name.value;
            const novoEmail = input_email.value; 
            const new_image = inputImagem.files[0]
            const senha = inputPassword.value;
            const novaSenha = inputNewPassword.value;
            
            if(novoNome !== "" && novoNome != user.displayName){
                updateProfile(user, {
                    displayName: novoNome,
                }).catch(function(error) {
                    alert("Erro ao atualizar o nome: " + error.message);
                });
            }


            if(novoEmail !== "" && novoEmail !== user.email){
                updateEmail(user, novoEmail)
                .catch(function(error) {
                    alert("Erro ao atualizar o email: " + error.message);
                });
            }

            

            if(new_image){
                const storageRef = ref(storage, `imagens_perfil/${user.uid}`);
                uploadBytes(storageRef, new_image)
                .then(function() {
                    getDownloadURL(storageRef)
                    .then(function(imgURL) {
                        updateProfile(user, {
                            photoURL: imgURL
                        }).catch(function(error) {
                            alert("Erro ao atualizar a imagem: " + error.message);
                        });
                    });
                })
                .catch(function(error) {
                    alert("Erro ao fazer upload da nova imagem: " + error.message);
                });
            }

            
            if(novaSenha !== ""){

            signInWithEmailAndPassword(auth,user.email, senha)
            .then(function(userCredential){
                const user = userCredential.user;
                updatePassword(user, novaSenha)
                .then(() => {
                    console.log("Senha atualizada com sucesso!");
                })
                .catch(error => {
                    console.error("Erro ao atualizar a senha:", error);
                });
                }).catch(function(error){
                    alert("Senha incorreta");
                });
            }

            alert("Dados Atualizados com Sucesso")
        })
    </script>
  </body>
</html>